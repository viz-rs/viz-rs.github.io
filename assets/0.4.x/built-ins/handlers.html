<article class=flex-1><h1 id=请求处理>请求处理<a class=anchor href=#请求处理>#</a></h1><p>在 Viz 中内置了一些方便的 <code>handler</code>，开启相应的特性，就可以使用它们。</p><table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><a href=https://docs.rs/viz/0.4.x/viz/handlers/serve/index.html><code>serve</code></a></td><td>静态文件和目录服务</td></tr><tr><td><a href=https://docs.rs/viz/0.4.x/viz/handlers/embed/index.html><code>embed</code></a></td><td>嵌入资源文件</td></tr><tr><td><a href=https://docs.rs/viz/0.4.x/viz/handlers/prometheus/index.html><code>prometheus</code></a></td><td>OpenTelemetry Prometheus Exporter</td></tr></tbody></table><h2 id=serve>serve<a class=anchor href=#serve>#</a></h2><p>可以灵活的对单个文件或者目录进行服务。</p><ul><li><p><a href=https://docs.rs/viz/0.4.x/viz/handlers/serve/struct.File.html><code>serve::File</code></a>：服务指定文件</p></li><li><p><a href=https://docs.rs/viz/0.4.x/viz/handlers/serve/struct.Dir.html><code>serve::Dir</code></a>：服务指定目录</p></li></ul><p>完整<a href=https://github.com/viz-rs/viz/tree/0.4.x/examples/static-files/serve>示例</a>。</p><h2 id=embed>embed<a class=anchor href=#embed>#</a></h2><p>可以把资源文件打包进执行文件中，生成单一文件，方便管理部署。</p><ul><li><p><a href=https://docs.rs/viz/0.4.x/viz/handlers/embed/struct.File.html><code>embed::File</code></a>：嵌入指定文件</p></li><li><p><a href=https://docs.rs/viz/0.4.x/viz/handlers/embed/struct.Dir.html><code>embed::Dir</code></a>：嵌入指定目录</p></li></ul><p>完整<a href=https://github.com/viz-rs/viz/tree/0.4.x/examples/static-files/embed>示例</a>。</p><h2 id=prometheus>prometheus<a class=anchor href=#prometheus>#</a></h2><p>可以输出当前 <code>metrics</code> 信息，以供 <code>Prometheus</code> 收集。</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>use</span> <span class=namespace>opentelemetry</span><span class=punctuation.delimiter>::</span><span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=namespace>global</span><span class=punctuation.delimiter>,</span>
</span><span class=line>    <span class=namespace>sdk</span><span class=punctuation.delimiter>::</span><span class=punctuation.bracket>{</span>
</span><span class=line>        <span class=namespace>export</span><span class=punctuation.delimiter>::</span><span class=namespace>metrics</span><span class=punctuation.delimiter>::</span><span class=namespace>aggregation</span><span class=punctuation.delimiter>,</span>
</span><span class=line>        <span class=namespace>metrics</span><span class=punctuation.delimiter>::</span><span class=punctuation.bracket>{</span><span class=namespace>controllers</span><span class=punctuation.delimiter>,</span> <span class=namespace>processors</span><span class=punctuation.delimiter>,</span> <span class=namespace>selectors</span><span class=punctuation.bracket>}</span><span class=punctuation.delimiter>,</span>
</span><span class=line>    <span class=punctuation.bracket>}</span><span class=punctuation.delimiter>,</span>
</span><span class=line><span class=punctuation.bracket>}</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=keyword>use</span> <span class=namespace>viz</span><span class=punctuation.delimiter>::</span><span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=namespace>handlers</span><span class=punctuation.delimiter>::</span><span class=namespace>prometheus</span><span class=punctuation.delimiter>::</span><span class=punctuation.bracket>{</span><span class=type>ExporterBuilder</span><span class=punctuation.delimiter>,</span> <span class=type>Prometheus</span><span class=punctuation.bracket>}</span><span class=punctuation.delimiter>,</span>
</span><span class=line><span class=punctuation.bracket>}</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=keyword>let</span> <span class=variable>exporter</span> <span class=operator>=</span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=keyword>let</span> <span class=variable>controller</span> <span class=operator>=</span> <span class=namespace>controllers</span><span class=punctuation.delimiter>::</span><span class=function>basic</span><span class=punctuation.bracket>(</span>
</span><span class=line>        <span class=namespace>processors</span><span class=punctuation.delimiter>::</span><span class=function>factory</span><span class=punctuation.bracket>(</span>
</span><span class=line>            <span class=namespace>selectors</span><span class=punctuation.delimiter>::</span><span class=namespace>simple</span><span class=punctuation.delimiter>::</span><span class=function>histogram</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>[</span><span class=constant>1.0</span><span class=punctuation.delimiter>,</span> <span class=constant>2.0</span><span class=punctuation.delimiter>,</span> <span class=constant>5.0</span><span class=punctuation.delimiter>,</span> <span class=constant>10.0</span><span class=punctuation.delimiter>,</span> <span class=constant>20.0</span><span class=punctuation.delimiter>,</span> <span class=constant>50.0</span><span class=punctuation.bracket>]</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>,</span>
</span><span class=line>            <span class=namespace>aggregation</span><span class=punctuation.delimiter>::</span><span class=function>cumulative_temporality_selector</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>,</span>
</span><span class=line>        <span class=punctuation.bracket>)</span>
</span><span class=line>        <span class=punctuation.delimiter>.</span><span class=function>with_memory</span><span class=punctuation.bracket>(</span><span class=constant.builtin>true</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>,</span>
</span><span class=line>    <span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>build</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span><span class=line>    <span class=type>ExporterBuilder</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=variable>controller</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=function>init</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line><span class=punctuation.bracket>}</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=keyword>let</span> <span class=variable>handler</span> <span class=operator>=</span> <span class=type>Prometheus</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=variable>exporter</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=keyword>let</span> <span class=variable>app</span> <span class=operator>=</span> <span class=type>Router</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>get</span><span class=punctuation.bracket>(</span><span class=string>"/metrics"</span><span class=punctuation.delimiter>,</span> <span class=variable>handler</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span></code></pre></div><p>完整<a href=https://github.com/viz-rs/viz/tree/0.4.x/examples/otel/metrics>示例</a>。</p><div class=page-nav><a class=prev-link href=/docs/0.4.x/concepts/error-handling><span class=desc><i class="block i-lucide-chevron-left w-3 h-3"></i> 前一篇</span><span class=title>错误处理</span></a><a class=next-link href=/docs/0.4.x/built-ins/middleware><span class=desc>下一篇 <i class="block i-lucide-chevron-right w-3 h-3"></i></span><span class=title>中间件</span></a></div></article><nav class="flex-col gap-5 hidden lg:flex"><div class="py-1 text-2 uppercase">本页目录</div><ul class=text-3><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#serve>serve</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#embed>embed</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#prometheus>prometheus</a></li></ul></nav>