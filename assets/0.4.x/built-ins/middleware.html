<article class=flex-1><h1 id=中间件>中间件<a class=anchor href=#中间件>#</a></h1><p>在 Viz 中同时也内置了一些方便的中间件，开启相应的特性，就可以使用它们。</p><table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><a href=https://docs.rs/viz-core/latest/viz_core/middleware/cookie>cookie</a></td><td>提供 Cooke 管理功能</td></tr><tr><td><a href=https://docs.rs/viz-core/latest/viz_core/middleware/cors>cors</a></td><td>跨资源共享处理</td></tr><tr><td><a href=https://docs.rs/viz-core/latest/viz_core/middleware/csrf>csrf</a></td><td>跨站请求伪造处理</td></tr><tr><td><a href=https://docs.rs/viz-core/latest/viz_core/middleware/limits>limits</a></td><td>请求主体大小限制</td></tr><tr><td><a href=https://docs.rs/viz-core/latest/viz_core/middleware/session>session</a></td><td>会话处理</td></tr><tr><td><a href=https://docs.rs/viz-core/latest/viz_core/middleware/compression>compression</a></td><td>响应主体压缩</td></tr><tr><td><a href=https://docs.rs/viz-core/latest/viz_core/middleware/otel/tracing>otel::tracing</a></td><td>OpenTelemetry Tracing</td></tr><tr><td><a href=https://docs.rs/viz-core/latest/viz_core/middleware/otel/metrics>otel::metrics</a></td><td>OpenTelemetry Metrics</td></tr></tbody></table><h2 id=cookie>Cookie<a class=anchor href=#cookie>#</a></h2><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>use</span> <span class=namespace>viz</span><span class=punctuation.delimiter>::</span><span class=namespace>middleware</span><span class=punctuation.delimiter>::</span><span class=namespace>cookie</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=keyword>let</span> <span class=variable>app</span> <span class=operator>=</span> <span class=type>Router</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>with</span><span class=punctuation.bracket>(</span><span class=namespace>cookie</span><span class=punctuation.delimiter>::</span><span class=type>Config</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span></code></pre></div><p>完整<a href=https://github.com/viz-rs/viz/tree/main/examples/session>示例</a>。</p><h2 id=cors>CORS<a class=anchor href=#cors>#</a></h2><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>use</span> <span class=namespace>viz</span><span class=punctuation.delimiter>::</span><span class=namespace>middleware</span><span class=punctuation.delimiter>::</span><span class=namespace>cors</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=keyword>let</span> <span class=variable>app</span> <span class=operator>=</span> <span class=type>Router</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>with</span><span class=punctuation.bracket>(</span><span class=namespace>cors</span><span class=punctuation.delimiter>::</span><span class=type>Config</span><span class=punctuation.delimiter>::</span><span class=function>default</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span></code></pre></div><p>完整<a href=https://github.com/viz-rs/viz/tree/main/examples/cors>示例</a>。</p><h2 id=csrf>CSRF<a class=anchor href=#csrf>#</a></h2><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>use</span> <span class=namespace>viz</span><span class=punctuation.delimiter>::</span><span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=namespace>middleware</span><span class=punctuation.delimiter>::</span><span class=punctuation.bracket>{</span>
</span><span class=line>        <span class=namespace>csrf</span><span class=punctuation.delimiter>::</span><span class=punctuation.bracket>{</span><span class=variable.builtin>self</span><span class=punctuation.delimiter>,</span> <span class=type>CsrfToken</span><span class=punctuation.bracket>}</span><span class=punctuation.delimiter>,</span>
</span><span class=line>        <span class=namespace>helper</span><span class=punctuation.delimiter>::</span><span class=type>CookieOptions</span><span class=punctuation.delimiter>,</span>
</span><span class=line>    <span class=punctuation.bracket>}</span><span class=punctuation.delimiter>,</span>
</span><span class=line><span class=punctuation.bracket>}</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=keyword>let</span> <span class=variable>app</span> <span class=operator>=</span> <span class=type>Router</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>with</span><span class=punctuation.bracket>(</span><span class=namespace>csrf</span><span class=punctuation.delimiter>::</span><span class=type>Config</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span>
</span><span class=line>        <span class=namespace>csrf</span><span class=punctuation.delimiter>::</span><span class=type>Store</span><span class=punctuation.delimiter>::</span><span class=type>Cookie</span><span class=punctuation.delimiter>,</span>
</span><span class=line>        <span class=punctuation.bracket>[</span><span class=type>Method</span><span class=punctuation.delimiter>::</span><span class=constant>GET</span><span class=punctuation.delimiter>,</span> <span class=type>Method</span><span class=punctuation.delimiter>::</span><span class=constant>HEAD</span><span class=punctuation.delimiter>,</span> <span class=type>Method</span><span class=punctuation.delimiter>::</span><span class=constant>OPTIONS</span><span class=punctuation.delimiter>,</span> <span class=type>Method</span><span class=punctuation.delimiter>::</span><span class=constant>TRACE</span><span class=punctuation.bracket>]</span><span class=punctuation.delimiter>.</span><span class=function>into</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>,</span>
</span><span class=line>        <span class=type>CookieOptions</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=string>"_csrf"</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=function>max_age</span><span class=punctuation.bracket>(</span><span class=type>Duration</span><span class=punctuation.delimiter>::</span><span class=function>from_secs</span><span class=punctuation.bracket>(</span><span class=constant>3600</span> <span class=operator>*</span> <span class=constant>24</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>,</span>
</span><span class=line>        <span class=namespace>csrf</span><span class=punctuation.delimiter>::</span><span class=namespace>secret</span><span class=punctuation.delimiter>,</span>
</span><span class=line>        <span class=namespace>csrf</span><span class=punctuation.delimiter>::</span><span class=namespace>generate</span><span class=punctuation.delimiter>,</span>
</span><span class=line>        <span class=namespace>csrf</span><span class=punctuation.delimiter>::</span><span class=namespace>verify</span><span class=punctuation.delimiter>,</span>
</span><span class=line>    <span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span></code></pre></div><p>完整<a href=https://github.com/viz-rs/viz/tree/main/examples/csrf>示例</a>。</p><h2 id=limits>Limits<a class=anchor href=#limits>#</a></h2><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>use</span> <span class=namespace>viz</span><span class=punctuation.delimiter>::</span><span class=namespace>middleware</span><span class=punctuation.delimiter>::</span><span class=namespace>limits</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=keyword>let</span> <span class=variable>app</span> <span class=operator>=</span> <span class=type>Router</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>with</span><span class=punctuation.bracket>(</span><span class=namespace>limits</span><span class=punctuation.delimiter>::</span><span class=type>Config</span><span class=punctuation.delimiter>::</span><span class=function>default</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span></code></pre></div><h2 id=session>Session<a class=anchor href=#session>#</a></h2><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>use</span> <span class=namespace>sessions</span><span class=punctuation.delimiter>::</span><span class=type>MemoryStorage</span><span class=punctuation.delimiter>;</span>
</span><span class=line><span class=keyword>use</span> <span class=namespace>viz</span><span class=punctuation.delimiter>::</span><span class=namespace>middleware</span><span class=punctuation.delimiter>::</span><span class=punctuation.bracket>{</span><span class=namespace>helper</span><span class=punctuation.delimiter>::</span><span class=type>CookieOptions</span><span class=punctuation.delimiter>,</span> <span class=namespace>session</span><span class=punctuation.delimiter>::</span><span class=punctuation.bracket>{</span><span class=variable.builtin>self</span><span class=punctuation.delimiter>,</span> <span class=type>Store</span><span class=punctuation.bracket>}</span><span class=punctuation.bracket>}</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=keyword>let</span> <span class=variable>app</span> <span class=operator>=</span> <span class=type>Router</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>with</span><span class=punctuation.bracket>(</span><span class=namespace>session</span><span class=punctuation.delimiter>::</span><span class=type>Config</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span>
</span><span class=line>        <span class=type>Store</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=type>MemoryStorage</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>,</span> <span class=namespace>nano_id</span><span class=punctuation.delimiter>::</span><span class=function>base64</span><span class=punctuation.delimiter>::</span><span class=punctuation.bracket><</span><span class=constant>32</span><span class=punctuation.bracket>></span><span class=punctuation.delimiter>,</span> <span class=punctuation.bracket>|</span><span class=parameter>sid</span>: <span class=keyword>&</span><span class=type.builtin>str</span><span class=punctuation.bracket>|</span> <span class=punctuation.bracket>{</span>
</span><span class=line>            <span class=parameter>sid</span><span class=punctuation.delimiter>.</span><span class=function>len</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span> <span class=operator>==</span> <span class=constant>32</span>
</span><span class=line>        <span class=punctuation.bracket>}</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>,</span>
</span><span class=line>        <span class=type>CookieOptions</span><span class=punctuation.delimiter>::</span><span class=function>default</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>,</span>
</span><span class=line>    <span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span></code></pre></div><p>完整<a href=https://github.com/viz-rs/viz/tree/main/examples/session>示例</a>。</p><h2 id=compression>Compression<a class=anchor href=#compression>#</a></h2><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>use</span> <span class=namespace>viz</span><span class=punctuation.delimiter>::</span><span class=namespace>middleware</span><span class=punctuation.delimiter>::</span><span class=namespace>compression</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=keyword>let</span> <span class=variable>app</span> <span class=operator>=</span> <span class=type>Router</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>with</span><span class=punctuation.bracket>(</span><span class=namespace>compression</span><span class=punctuation.delimiter>::</span><span class=type>Config</span><span class=punctuation.delimiter>::</span><span class=function>default</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span></code></pre></div><p>完整<a href=https://github.com/viz-rs/viz/tree/main/examples/compression>示例</a>。</p><h2 id=opentelemetry-tracing>OpenTelemetry Tracing<a class=anchor href=#opentelemetry-tracing>#</a></h2><p>完整<a href=https://github.com/viz-rs/viz/tree/main/examples/otel/tracing>示例</a>。</p><h2 id=opentelemetry-metrics>OpenTelemetry Metrics<a class=anchor href=#opentelemetry-metrics>#</a></h2><p>完整<a href=https://github.com/viz-rs/viz/tree/main/examples/otel/metrics>示例</a>。</p></article><nav class="flex-col gap-5 hidden lg:flex"><div class="py-1 text-2 uppercase">本页目录</div><ul class=text-3><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#cookie>Cookie</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#cors>CORS</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#csrf>CSRF</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#limits>Limits</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#session>Session</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#compression>Compression</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#opentelemetry-tracing>OpenTelemetry Tracing</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#opentelemetry-metrics>OpenTelemetry Metrics</a></li></ul></nav>