<article class=flex-1><h1 id=错误处理>错误处理<a class=anchor href=#错误处理>#</a></h1><p>先回顾 <a href=https://docs.rs/viz/latest/viz/trait.Handler.html><code>Handler</code></a> 特征的定义：</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>async_trait</span><span class=punctuation.bracket>]</span>
</span><span class=line><span class=keyword>pub</span> <span class=keyword>trait</span> <span class=type>Handler</span><span class=punctuation.bracket><</span><span class=type>Input</span><span class=punctuation.bracket>></span>: <span class=namespace>dyn_clone</span><span class=punctuation.delimiter>::</span><span class=type>DynClone</span> <span class=operator>+</span> <span class=type>Send</span> <span class=operator>+</span> <span class=type>Sync</span> <span class=operator>+</span> <span class=label>'</span><span class=label>static</span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=keyword>type</span> <span class=type>Output</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line>    <span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>must_use</span><span class=punctuation.bracket>]</span>
</span><span class=line>    <span class=keyword>async</span> <span class=keyword.function>fn</span> <span class=function>call</span><span class=punctuation.bracket>(</span><span class=keyword>&</span><span class=variable.builtin>self</span><span class=punctuation.delimiter>,</span> <span class=parameter>input</span>: <span class=type>Input</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Self</span><span class=punctuation.delimiter>::</span><span class=type>Output</span><span class=punctuation.delimiter>;</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span></code></pre></div><p>还有异步函数对 <a href=https://docs.rs/viz/latest/viz/trait.Handler.html><code>Handler</code></a> 特征的实现：</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>async_trait</span><span class=punctuation.bracket>]</span>
</span><span class=line><span class=keyword>impl</span><span class=punctuation.bracket><</span><span class=type>F</span><span class=punctuation.delimiter>,</span> <span class=type>I</span><span class=punctuation.delimiter>,</span> <span class=type>Fut</span><span class=punctuation.delimiter>,</span> <span class=type>O</span><span class=punctuation.bracket>></span> <span class=type>Handler</span><span class=punctuation.bracket><</span><span class=type>I</span><span class=punctuation.bracket>></span> <span class=keyword>for</span> <span class=type>F</span>
</span><span class=line><span class=keyword>where</span>
</span><span class=line>    <span class=type>I</span>: <span class=type>Send</span> <span class=operator>+</span> <span class=label>'</span><span class=label>static</span><span class=punctuation.delimiter>,</span>
</span><span class=line>    <span class=type>F</span>: <span class=type>Fn</span><span class=punctuation.bracket>(</span><span class=type>I</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Fut</span> <span class=operator>+</span> ?<span class=type>Sized</span> <span class=operator>+</span> <span class=type>Clone</span> <span class=operator>+</span> <span class=type>Send</span> <span class=operator>+</span> <span class=type>Sync</span> <span class=operator>+</span> <span class=label>'</span><span class=label>static</span><span class=punctuation.delimiter>,</span>
</span><span class=line>    <span class=type>Fut</span>: <span class=type>Future</span><span class=punctuation.bracket><</span><span class=type>Output</span> <span class=operator>=</span> <span class=type>O</span><span class=punctuation.bracket>></span> <span class=operator>+</span> <span class=type>Send</span><span class=punctuation.delimiter>,</span>
</span><span class=line><span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=keyword>type</span> <span class=type>Output</span> <span class=operator>=</span> <span class=type>Fut</span><span class=punctuation.delimiter>::</span><span class=type>Output</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line>    <span class=keyword>async</span> <span class=keyword.function>fn</span> <span class=function>call</span><span class=punctuation.bracket>(</span><span class=keyword>&</span><span class=variable.builtin>self</span><span class=punctuation.delimiter>,</span> <span class=parameter>i</span>: <span class=type>I</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Self</span><span class=punctuation.delimiter>::</span><span class=type>Output</span> <span class=punctuation.bracket>{</span>
</span><span class=line>        <span class=punctuation.bracket>(</span><span class=variable.builtin>self</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>(</span><span class=parameter>i</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=keyword>await</span>
</span><span class=line>    <span class=punctuation.bracket>}</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span></code></pre></div><p>根据上面就可以声明一个真实的异步函数：</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>async</span> <span class=keyword.function>fn</span> <span class=function>index</span><span class=punctuation.bracket>(</span>_: <span class=type>Request</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Result</span><span class=punctuation.bracket><</span><span class=type>Response</span><span class=punctuation.bracket>></span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"Hello, World!"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span></code></pre></div><p>或者（闭包函数）：</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=punctuation.bracket>|</span><span class=parameter>req</span>: <span class=type>Request</span><span class=punctuation.bracket>|</span> <span class=keyword>async</span> <span class=punctuation.bracket>{</span> <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=string>"Hello"</span><span class=punctuation.delimiter>.</span><span class=function>into_response</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span> <span class=punctuation.bracket>}</span>
</span></code></pre></div><p>其中 <code>Input = Request</code>，<code>Output = Result&LTResponse></code>。</p><p>对 <code>Result&LTResponse></code> 补全， 将是 <code>Result&LTResponse, <a href=https://docs.rs/viz/latest/viz/enum.Error.html>Error</a>></code></p><ol><li>为什么不直接返回 <a href=https://docs.rs/viz/latest/viz/struct.Response.html><code>Response</code></a>？</li></ol><p>因为在实际场景中，需要判断文件、IO、DB 等的常规错误，所以返回 <code>Result&LTResponse></code> 是最合适的。 也能利用 <code>?</code> 操作符，尽早返回错误，响应给客户端。</p><ol start=2><li>为什么不直接返回 <code>impl <a href=https://docs.rs/viz/latest/viz/trait.IntoResponse.htm>IntoResponse</a></code>？</li></ol><p>虽然已经对 <code>Result&LTT></code> 实现了 <a href=https://docs.rs/viz/latest/viz/trait.IntoResponse.html><code>IntoResponse</code></a> 特征，但有个特殊情况，如果 <code>T = Result&LTR></code>， 在 <a href=https://doc.rust-lang.org/std/result/enum.Result.html#method.flatten><code>fatten</code></a> 未稳定的情况下，暂时还无法打平结果，因此无法正常返回。</p><ol start=3><li>如何自定义错误及响应？</li></ol><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>derive</span><span class=punctuation.bracket>(</span><span class=namespace>thiserror</span><span class=punctuation.delimiter>::</span><span class=type>Error</span><span class=punctuation.delimiter>,</span> <span class=type>Debug</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>]</span>
</span><span class=line><span class=keyword>enum</span> <span class=type>MyError</span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>error</span><span class=punctuation.bracket>(</span><span class=string>"Not Found"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>]</span>
</span><span class=line>    <span class=type>NotFound</span><span class=punctuation.delimiter>,</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span><span class=line>
</span><span class=line><span class=keyword>impl</span> <span class=type>From</span><span class=punctuation.bracket><</span><span class=type>MyError</span><span class=punctuation.bracket>></span> <span class=keyword>for</span> <span class=type>Error</span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=keyword.function>fn</span> <span class=function>from</span><span class=punctuation.bracket>(</span><span class=parameter>e</span>: <span class=type>MyError</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Self</span> <span class=punctuation.bracket>{</span>
</span><span class=line>        <span class=comment>// Error::Responder(e.into_response())</span>
</span><span class=line>        <span class=type>Error</span><span class=punctuation.delimiter>::</span><span class=type>Report</span><span class=punctuation.bracket>(</span><span class=type>Box</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=parameter>e</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>,</span> <span class=type>MyError</span><span class=punctuation.delimiter>::</span><span class=type>NotFound</span><span class=punctuation.delimiter>.</span><span class=function>into_response</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.bracket>}</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span><span class=line>
</span><span class=line><span class=keyword>impl</span> <span class=type>IntoResponse</span> <span class=keyword>for</span> <span class=type>MyError</span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=keyword.function>fn</span> <span class=function>into_response</span><span class=punctuation.bracket>(</span><span class=variable.builtin>self</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Response</span> <span class=punctuation.bracket>{</span>
</span><span class=line>        <span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>builder</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>            <span class=punctuation.delimiter>.</span><span class=function>status</span><span class=punctuation.bracket>(</span><span class=type>StatusCode</span><span class=punctuation.delimiter>::</span><span class=constant>NOT_FOUND</span><span class=punctuation.bracket>)</span>
</span><span class=line>            <span class=punctuation.delimiter>.</span><span class=function>body</span><span class=punctuation.bracket>(</span><span class=variable.builtin>self</span><span class=punctuation.delimiter>.</span><span class=function>to_string</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=function>into</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span>
</span><span class=line>            <span class=punctuation.delimiter>.</span><span class=function>unwrap</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.bracket>}</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span></code></pre></div></article>