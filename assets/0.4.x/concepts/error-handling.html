<article class=flex-1><h1 id=error-handling>Error Handling<a class=anchor href=#error-handling>#</a></h1><p>Recall first the definition of the <a href=https://docs.rs/viz/0.4.x/viz/trait.Handler.html><code>Handler</code></a> trait:</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>async_trait</span><span class=punctuation.bracket>]</span>
</span><span class=line><span class=keyword>pub</span> <span class=keyword>trait</span> <span class=type>Handler</span><span class=punctuation.bracket><</span><span class=type>Input</span><span class=punctuation.bracket>></span>: <span class=namespace>dyn_clone</span><span class=punctuation.delimiter>::</span><span class=type>DynClone</span> <span class=operator>+</span> <span class=type>Send</span> <span class=operator>+</span> <span class=type>Sync</span> <span class=operator>+</span> <span class=label>'</span><span class=label>static</span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=keyword>type</span> <span class=type>Output</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line>    <span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>must_use</span><span class=punctuation.bracket>]</span>
</span><span class=line>    <span class=keyword>async</span> <span class=keyword.function>fn</span> <span class=function>call</span><span class=punctuation.bracket>(</span><span class=keyword>&</span><span class=variable.builtin>self</span><span class=punctuation.delimiter>,</span> <span class=parameter>input</span>: <span class=type>Input</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Self</span><span class=punctuation.delimiter>::</span><span class=type>Output</span><span class=punctuation.delimiter>;</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span></code></pre></div><p>And the implementation of the <a href=https://docs.rs/viz/0.4.x/viz/trait.Handler.html><code>Handler</code></a> trait by asynchronous functions:</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>async_trait</span><span class=punctuation.bracket>]</span>
</span><span class=line><span class=keyword>impl</span><span class=punctuation.bracket><</span><span class=type>F</span><span class=punctuation.delimiter>,</span> <span class=type>I</span><span class=punctuation.delimiter>,</span> <span class=type>Fut</span><span class=punctuation.delimiter>,</span> <span class=type>O</span><span class=punctuation.bracket>></span> <span class=type>Handler</span><span class=punctuation.bracket><</span><span class=type>I</span><span class=punctuation.bracket>></span> <span class=keyword>for</span> <span class=type>F</span>
</span><span class=line><span class=keyword>where</span>
</span><span class=line>    <span class=type>I</span>: <span class=type>Send</span> <span class=operator>+</span> <span class=label>'</span><span class=label>static</span><span class=punctuation.delimiter>,</span>
</span><span class=line>    <span class=type>F</span>: <span class=type>Fn</span><span class=punctuation.bracket>(</span><span class=type>I</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Fut</span> <span class=operator>+</span> ?<span class=type>Sized</span> <span class=operator>+</span> <span class=type>Clone</span> <span class=operator>+</span> <span class=type>Send</span> <span class=operator>+</span> <span class=type>Sync</span> <span class=operator>+</span> <span class=label>'</span><span class=label>static</span><span class=punctuation.delimiter>,</span>
</span><span class=line>    <span class=type>Fut</span>: <span class=type>Future</span><span class=punctuation.bracket><</span><span class=type>Output</span> <span class=operator>=</span> <span class=type>O</span><span class=punctuation.bracket>></span> <span class=operator>+</span> <span class=type>Send</span><span class=punctuation.delimiter>,</span>
</span><span class=line><span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=keyword>type</span> <span class=type>Output</span> <span class=operator>=</span> <span class=type>Fut</span><span class=punctuation.delimiter>::</span><span class=type>Output</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line>    <span class=keyword>async</span> <span class=keyword.function>fn</span> <span class=function>call</span><span class=punctuation.bracket>(</span><span class=keyword>&</span><span class=variable.builtin>self</span><span class=punctuation.delimiter>,</span> <span class=parameter>i</span>: <span class=type>I</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Self</span><span class=punctuation.delimiter>::</span><span class=type>Output</span> <span class=punctuation.bracket>{</span>
</span><span class=line>        <span class=punctuation.bracket>(</span><span class=variable.builtin>self</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>(</span><span class=parameter>i</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=keyword.return>await</span>
</span><span class=line>    <span class=punctuation.bracket>}</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span></code></pre></div><p>A real asynchronous function can be declared according to the above:</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>async</span> <span class=keyword.function>fn</span> <span class=function>index</span><span class=punctuation.bracket>(</span>_: <span class=type>Request</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Result</span><span class=punctuation.bracket><</span><span class=type>Response</span><span class=punctuation.bracket>></span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"Hello, World!"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span></code></pre></div><p>Or (closure function):</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=punctuation.bracket>|</span><span class=parameter>req</span>: <span class=type>Request</span><span class=punctuation.bracket>|</span> <span class=keyword>async</span> <span class=punctuation.bracket>{</span> <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=string>"Hello"</span><span class=punctuation.delimiter>.</span><span class=function>into_response</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span> <span class=punctuation.bracket>}</span>
</span></code></pre></div><p>Which <code>Input = Request</code>ï¼Œ<code>Output = Result&LTResponse></code>.</p><p>Completing <code>Result&LTResponse></code> would be <code>Result&LTResponse, <a href=https://docs.rs/viz/0.4.x/viz/enum.Error.html>Error</a>></code></p><ol><li>Why not just return <a href=https://docs.rs/viz/0.4.x/viz/struct.Response.html><code>Response</code></a>?</li></ol><p>Since in a real-world scenario, you need to determine regular errors in files, IO, DB, etc., returning <code>Result&LTResponse></code> is the most appropriate. It is also possible to use <code>?</code> operator to return an error early and respond to the client.</p><ol start=2><li>Why not just return <code>impl <a href=https://docs.rs/viz/0.4.x/viz/trait.IntoResponse.html>IntoResponse</a></code>?</li></ol><p>Although the <a href=https://docs.rs/viz/0.4.x/viz/trait.IntoResponse.html><code>IntoResponse</code></a> feature has been implemented for <code>Result&LTT></code>, there is a special case if <code>T = Result&LTR></code>, in which <a href=https://doc.rust-lang.org/std/result/enum.Result.html#method.flatten><code>fatten</code></a> is not stable, the result cannot be tied yet, so it cannot be returned properly.</p><ol start=3><li>How to customize the error and response?</li></ol><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>derive</span><span class=punctuation.bracket>(</span><span class=function.macro>thiserror</span>::<span class=type>Error</span>, <span class=type>Debug</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>]</span>
</span><span class=line><span class=keyword>enum</span> <span class=type>MyError</span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>error</span><span class=punctuation.bracket>(</span><span class=string>"Not Found"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>]</span>
</span><span class=line>    <span class=type>NotFound</span><span class=punctuation.delimiter>,</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span><span class=line>
</span><span class=line><span class=keyword>impl</span> <span class=type>From</span><span class=punctuation.bracket><</span><span class=type>MyError</span><span class=punctuation.bracket>></span> <span class=keyword>for</span> <span class=type>Error</span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=keyword.function>fn</span> <span class=function>from</span><span class=punctuation.bracket>(</span><span class=parameter>e</span>: <span class=type>MyError</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Self</span> <span class=punctuation.bracket>{</span>
</span><span class=line>        <span class=comment>// Error::Responder(e.into_response())</span>
</span><span class=line>        <span class=type>Error</span><span class=punctuation.delimiter>::</span><span class=type>Report</span><span class=punctuation.bracket>(</span><span class=type>Box</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=parameter>e</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>,</span> <span class=type>MyError</span><span class=punctuation.delimiter>::</span><span class=type>NotFound</span><span class=punctuation.delimiter>.</span><span class=function>into_response</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.bracket>}</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span><span class=line>
</span><span class=line><span class=keyword>impl</span> <span class=type>IntoResponse</span> <span class=keyword>for</span> <span class=type>MyError</span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=keyword.function>fn</span> <span class=function>into_response</span><span class=punctuation.bracket>(</span><span class=variable.builtin>self</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Response</span> <span class=punctuation.bracket>{</span>
</span><span class=line>        <span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>builder</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>            <span class=punctuation.delimiter>.</span><span class=function>status</span><span class=punctuation.bracket>(</span><span class=type>StatusCode</span><span class=punctuation.delimiter>::</span><span class=constant>NOT_FOUND</span><span class=punctuation.bracket>)</span>
</span><span class=line>            <span class=punctuation.delimiter>.</span><span class=function>body</span><span class=punctuation.bracket>(</span><span class=variable.builtin>self</span><span class=punctuation.delimiter>.</span><span class=function>to_string</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=function>into</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span>
</span><span class=line>            <span class=punctuation.delimiter>.</span><span class=function>unwrap</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.bracket>}</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span></code></pre></div></article>