<article class=flex-1><h1 id=中间件>中间件<a class=anchor href=#中间件>#</a></h1><p>在 Viz 中，中间件模型跟请求处理共用一个特征 <a href=https://docs.rs/viz/latest/viz/trait.Handler.html><code>Handler</code></a>，即简化了模型，也降低了开发难度。</p><h2 id=基本函数>基本函数<a class=anchor href=#基本函数>#</a></h2><p>以下是一个最基本的中间件函数：</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>async</span> <span class=keyword.function>fn</span> <span class=function>middleware</span><span class=punctuation.bracket><</span><span class=type>H</span><span class=punctuation.bracket>></span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>(</span><span class=variable>req</span><span class=punctuation.delimiter>,</span> <span class=variable>handler</span><span class=punctuation.bracket>)</span>: <span class=type>Next</span><span class=punctuation.bracket><</span><span class=type>Request</span><span class=punctuation.delimiter>,</span> <span class=type>H</span><span class=punctuation.bracket>></span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Result</span><span class=punctuation.bracket><</span><span class=type>Response</span><span class=punctuation.bracket>></span>
</span><span class=line><span class=keyword>where</span>
</span><span class=line>    <span class=type>H</span>: <span class=type>Handler</span><span class=punctuation.bracket><</span><span class=type>Request</span><span class=punctuation.delimiter>,</span> <span class=type>Output</span> <span class=operator>=</span> <span class=type>Result</span><span class=punctuation.bracket><</span><span class=type>Response</span><span class=punctuation.bracket>></span><span class=punctuation.bracket>></span> <span class=operator>+</span> <span class=type>Clone</span><span class=punctuation.delimiter>,</span>
</span><span class=line><span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=comment>// 在执行 handler 之前，可以对 request 做些处理</span>
</span><span class=line>    <span class=keyword>let</span> <span class=variable>resp</span> <span class=operator>=</span> <span class=variable>handler</span><span class=punctuation.delimiter>.</span><span class=function>call</span><span class=punctuation.bracket>(</span><span class=variable>req</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=keyword.return>await</span><span class=punctuation.delimiter>;</span>
</span><span class=line>    <span class=comment>// 在执行 handler 之后，可以对 response 做些处理</span>
</span><span class=line>    <span class=variable>resp</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span></code></pre></div><p>其中输入参数是一个包含两个元素的元组类型 <code><a href=https://docs.rs/viz/latest/viz/type.Next.html>Next&LTRequest, H></a></code>：</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>pub</span> <span class=keyword>type</span> <span class=type>Next</span><span class=punctuation.bracket><</span><span class=type>I</span><span class=punctuation.delimiter>,</span> <span class=type>H</span><span class=punctuation.bracket>></span> <span class=operator>=</span> <span class=punctuation.bracket>(</span><span class=type>I</span><span class=punctuation.delimiter>,</span> <span class=type>H</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span></code></pre></div><p>然后输出结果 <code>Result<<a href=https://docs.rs/viz/latest/viz/type.Response.html>Response</a>></code> 进行返回。</p><h2 id=自定义类型>自定义类型<a class=anchor href=#自定义类型>#</a></h2><p>当然也可以通过定义新类型来构造中间件。</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>derive</span><span class=punctuation.bracket>(</span><span class=type>Clone</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>]</span>
</span><span class=line><span class=keyword>struct</span> <span class=type>MyMiddleware</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>async_trait</span><span class=punctuation.bracket>]</span>
</span><span class=line><span class=keyword>impl</span><span class=punctuation.bracket><</span><span class=type>H</span><span class=punctuation.bracket>></span> <span class=type>Handler</span><span class=punctuation.bracket><</span><span class=type>Next</span><span class=punctuation.bracket><</span><span class=type>Request</span><span class=punctuation.delimiter>,</span> <span class=type>H</span><span class=punctuation.bracket>></span><span class=punctuation.bracket>></span> <span class=keyword>for</span> <span class=type>MyMiddleware</span>
</span><span class=line><span class=keyword>where</span>
</span><span class=line>    <span class=type>H</span>: <span class=type>Handler</span><span class=punctuation.bracket><</span><span class=type>Request</span><span class=punctuation.delimiter>,</span> <span class=type>Output</span> <span class=operator>=</span> <span class=type>Result</span><span class=punctuation.bracket><</span><span class=type>Response</span><span class=punctuation.bracket>></span><span class=punctuation.bracket>></span> <span class=operator>+</span> <span class=type>Clone</span><span class=punctuation.delimiter>,</span>
</span><span class=line><span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=keyword>type</span> <span class=type>Output</span> <span class=operator>=</span> <span class=constant>H</span><span class=punctuation.delimiter>::</span><span class=type>Output</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line>    <span class=keyword>async</span> <span class=keyword.function>fn</span> <span class=function>call</span><span class=punctuation.bracket>(</span><span class=keyword>&</span><span class=variable.builtin>self</span><span class=punctuation.delimiter>,</span> <span class=punctuation.bracket>(</span><span class=variable>req</span><span class=punctuation.delimiter>,</span> <span class=variable>handler</span><span class=punctuation.bracket>)</span>: <span class=type>Next</span><span class=punctuation.bracket><</span><span class=type>Request</span><span class=punctuation.delimiter>,</span> <span class=type>H</span><span class=punctuation.bracket>></span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Self</span><span class=punctuation.delimiter>::</span><span class=type>Output</span> <span class=punctuation.bracket>{</span>
</span><span class=line>        <span class=comment>// 在执行 handler 之前，可以对 request 做些处理</span>
</span><span class=line>        <span class=keyword>let</span> <span class=variable>resp</span> <span class=operator>=</span> <span class=variable>handler</span><span class=punctuation.delimiter>.</span><span class=function>call</span><span class=punctuation.bracket>(</span><span class=variable>req</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=keyword.return>await</span><span class=punctuation.delimiter>;</span>
</span><span class=line>        <span class=comment>// 在执行 handler 之后，可以对 response 做些处理</span>
</span><span class=line>        <span class=variable>resp</span>
</span><span class=line>    <span class=punctuation.bracket>}</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span></code></pre></div><blockquote><p>可以打开 「请求处理」进行对比，它们非常相似，只是参数不同而已，<code>Handler</code> 节省了我们很多脑力。🦀️</p></blockquote></article><nav class="flex-col gap-5 hidden lg:flex"><div class="py-1 text-2 uppercase">本页目录</div><ul class=text-3><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#基本函数>基本函数</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#自定义类型>自定义类型</a></li></ul></nav>