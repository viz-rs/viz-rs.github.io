<article class=flex-1><h1 id=middleware>Middleware<a class=anchor href=#middleware>#</a></h1><p>In Viz, the middleware model and request processing share a common trait <a href=https://docs.rs/viz/0.4.x/viz/trait.Handler.html><code>Handler</code></a>, which simplifies the model and reduces development effort.</p><h2 id=basic-functions>Basic functions<a class=anchor href=#basic-functions>#</a></h2><p>The following is a minimal middleware function:</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>async</span> <span class=keyword.function>fn</span> <span class=function>middleware</span><span class=punctuation.bracket><</span><span class=type>H</span><span class=punctuation.bracket>></span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>(</span><span class=variable>req</span><span class=punctuation.delimiter>,</span> <span class=variable>handler</span><span class=punctuation.bracket>)</span>: <span class=type>Next</span><span class=punctuation.bracket><</span><span class=type>Request</span><span class=punctuation.delimiter>,</span> <span class=type>H</span><span class=punctuation.bracket>></span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Result</span><span class=punctuation.bracket><</span><span class=type>Response</span><span class=punctuation.bracket>></span>
</span><span class=line><span class=keyword>where</span>
</span><span class=line>    <span class=type>H</span>: <span class=type>Handler</span><span class=punctuation.bracket><</span><span class=type>Request</span><span class=punctuation.delimiter>,</span> <span class=type>Output</span> <span class=operator>=</span> <span class=type>Result</span><span class=punctuation.bracket><</span><span class=type>Response</span><span class=punctuation.bracket>></span><span class=punctuation.bracket>></span> <span class=operator>+</span> <span class=type>Clone</span><span class=punctuation.delimiter>,</span>
</span><span class=line><span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=comment>// before executing the handler, you can do some processing on the request</span>
</span><span class=line>    <span class=keyword>let</span> <span class=variable>resp</span> <span class=operator>=</span> <span class=variable>handler</span><span class=punctuation.delimiter>.</span><span class=function>call</span><span class=punctuation.bracket>(</span><span class=variable>req</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=keyword.return>await</span><span class=punctuation.delimiter>;</span>
</span><span class=line>    <span class=comment>// after the handler is executed, something can be done with the response</span>
</span><span class=line>    <span class=variable>resp</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span></code></pre></div><p>Where the input parameter is a tuple type containing two elements <code><a href=https://docs.rs/viz/0.4.x/viz/type.Next.html>Next&LTRequest, H></a></code>Ôºö</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>pub</span> <span class=keyword>type</span> <span class=type>Next</span><span class=punctuation.bracket><</span><span class=type>I</span><span class=punctuation.delimiter>,</span> <span class=type>H</span><span class=punctuation.bracket>></span> <span class=operator>=</span> <span class=punctuation.bracket>(</span><span class=type>I</span><span class=punctuation.delimiter>,</span> <span class=type>H</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span></code></pre></div><p>The output is then returned <code>Result<<a href=https://docs.rs/viz/0.4.x/viz/type.Response.html>Response</a>></code>.</p><h2 id=custom-types>Custom Types<a class=anchor href=#custom-types>#</a></h2><p>Of course it is also possible to construct middleware by defining new types.</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>derive</span><span class=punctuation.bracket>(</span><span class=type>Clone</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>]</span>
</span><span class=line><span class=keyword>struct</span> <span class=type>MyMiddleware</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>async_trait</span><span class=punctuation.bracket>]</span>
</span><span class=line><span class=keyword>impl</span><span class=punctuation.bracket><</span><span class=type>H</span><span class=punctuation.bracket>></span> <span class=type>Handler</span><span class=punctuation.bracket><</span><span class=type>Next</span><span class=punctuation.bracket><</span><span class=type>Request</span><span class=punctuation.delimiter>,</span> <span class=type>H</span><span class=punctuation.bracket>></span><span class=punctuation.bracket>></span> <span class=keyword>for</span> <span class=type>MyMiddleware</span>
</span><span class=line><span class=keyword>where</span>
</span><span class=line>    <span class=type>H</span>: <span class=type>Handler</span><span class=punctuation.bracket><</span><span class=type>Request</span><span class=punctuation.delimiter>,</span> <span class=type>Output</span> <span class=operator>=</span> <span class=type>Result</span><span class=punctuation.bracket><</span><span class=type>Response</span><span class=punctuation.bracket>></span><span class=punctuation.bracket>></span> <span class=operator>+</span> <span class=type>Clone</span><span class=punctuation.delimiter>,</span>
</span><span class=line><span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=keyword>type</span> <span class=type>Output</span> <span class=operator>=</span> <span class=constant>H</span><span class=punctuation.delimiter>::</span><span class=type>Output</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line>    <span class=keyword>async</span> <span class=keyword.function>fn</span> <span class=function>call</span><span class=punctuation.bracket>(</span><span class=keyword>&</span><span class=variable.builtin>self</span><span class=punctuation.delimiter>,</span> <span class=punctuation.bracket>(</span><span class=variable>req</span><span class=punctuation.delimiter>,</span> <span class=variable>handler</span><span class=punctuation.bracket>)</span>: <span class=type>Next</span><span class=punctuation.bracket><</span><span class=type>Request</span><span class=punctuation.delimiter>,</span> <span class=type>H</span><span class=punctuation.bracket>></span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Self</span><span class=punctuation.delimiter>::</span><span class=type>Output</span> <span class=punctuation.bracket>{</span>
</span><span class=line>        <span class=comment>// before executing the handler, you can do some processing on the request</span>
</span><span class=line>        <span class=keyword>let</span> <span class=variable>resp</span> <span class=operator>=</span> <span class=variable>handler</span><span class=punctuation.delimiter>.</span><span class=function>call</span><span class=punctuation.bracket>(</span><span class=variable>req</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=keyword.return>await</span><span class=punctuation.delimiter>;</span>
</span><span class=line>        <span class=comment>// after the handler is executed, something can be done with the response</span>
</span><span class=line>        <span class=variable>resp</span>
</span><span class=line>    <span class=punctuation.bracket>}</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span></code></pre></div><blockquote><p>You can open ‚Äúhandler‚Äù for comparison, they are very similar, just with different parameters, <code>Handler</code> saves us a lot of brain power. ü¶ÄÔ∏è</p></blockquote><div class=page-nav><a class=prev-link href=/docs/0.4.x/concepts/handler><span class=desc><i class="block i-lucide-chevron-left w-3 h-3"></i> Previous</span><span class=title>Handler</span></a><a class=next-link href=/docs/0.4.x/concepts/routing><span class=desc>Next <i class="block i-lucide-chevron-right w-3 h-3"></i></span><span class=title>Routing</span></a></div></article><nav class="flex-col gap-5 hidden lg:flex"><div class="py-1 text-2 uppercase">On this page</div><ul class=text-3><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#basic-functions>Basic functions</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#custom-types>Custom Types</a></li></ul></nav>