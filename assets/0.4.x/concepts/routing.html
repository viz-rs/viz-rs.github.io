<article class=flex-1><h1 id=路由>路由<a class=anchor href=#路由>#</a></h1><p>路由是整个 Web 应用的交通枢纽，对连接视图、控制、数据起到承上启下的作用。</p><p>在 Viz 的路由系统中，使用 <a href=https://github.com/viz-rs/path-tree><code>path-tree</code></a> 模块来存储 <code>path</code> 和 <code>handler</code> 之间的关系。</p><p><a href=https://github.com/viz-rs/path-tree><code>path-tree</code></a> 核心是一个<a href=https://en.wikipedia.org/wiki/Trie>前缀树</a>实现，提供一个高效的搜索引擎和一些友好的辅助方法。</p><h2 id=概念及结构>概念及结构<a class=anchor href=#概念及结构>#</a></h2><ul><li><p><a href=https://docs.rs/viz/latest/viz/struct.Route.html><code>Route</code></a>：基础结构，是 <a href=https://docs.rs/viz/latest/viz/struct.Method.html><code>Method</code></a> - <a href=https://docs.rs/viz/latest/viz/handler/trait.Handler.html><code>Handler</code></a> 对的合集。</p></li><li><p><a href=https://docs.rs/viz/latest/viz/struct.Resources.html><code>Resources</code></a>：资源结构，通过对 <code>Action</code> - <a href=https://docs.rs/viz/latest/viz/struct.Method.html><code>Method</code></a> 之间的映射，来进行 CRUD 操作。</p></li><li><p><a href=https://docs.rs/viz/latest/viz/struct.Router.html><code>Router</code></a>：是对 <a href=https://docs.rs/viz/latest/viz/struct.Route.html><code>Route</code></a>、<a href=https://docs.rs/viz/latest/viz/struct.Resources.html><code>Resources</code></a>、嵌套路由，中间件的管理和维护。</p></li></ul><h2 id=路径参数>路径参数<a class=anchor href=#路径参数>#</a></h2><p>得益于 <a href=https://github.com/viz-rs/path-tree><code>path-tree</code></a> 提供的支持，在路径中，可以通过 <code>:</code> 对参数命名，<code>?</code> <code>+</code> <code>*</code> 对参数设置类型。</p><table><thead><tr><th>模式</th><th>规则</th></tr></thead><tbody><tr><td><code>:name</code></td><td>匹配除 <code>/</code> 以外的字符</td></tr><tr><td><code>:name?</code></td><td>匹配除 <code>/</code> 以外的字符，可选</td></tr><tr><td><code>/:name?/</code> <code>/:name?</code></td><td>匹配以 <code>/</code> 开头或结尾，但除 <code>/</code> 以外的字符，可选</td></tr><tr><td><code>+</code> <code>:name+</code></td><td>匹配长度 > 0 的字符串</td></tr><tr><td><code>*</code> <code>:name*</code></td><td>匹配长度 >= 0 的字符串</td></tr><tr><td><code>/*</code> <code>/*/</code> <code>/:name*/</code> <code>/:name*</code></td><td>匹配以 <code>/</code> 开头或结尾，且长度 >= 0 的字符串</td></tr></tbody></table><p>后续可以通过 <a href=https://docs.rs/viz/latest/viz/types/struct.Params.html><code>Params&LTT></code></a> 提取器对参数进行提取。</p><blockquote><p>同时也支持<strong>连续参数</strong>和参数之间穿插特殊字符进行分割。</p></blockquote><h2 id=方法路由>方法路由<a class=anchor href=#方法路由>#</a></h2><p>使用 HTTP 方法添加路由。支持以下方法：</p><ul><li><a href=https://docs.rs/viz/latest/viz/struct.Router.html#method.get><code>get</code></a></li><li><a href=https://docs.rs/viz/latest/viz/struct.Router.html#method.post><code>post</code></a></li><li><a href=https://docs.rs/viz/latest/viz/struct.Router.html#method.put><code>put</code></a></li><li><a href=https://docs.rs/viz/latest/viz/struct.Router.html#method.delete><code>delete</code></a></li><li><a href=https://docs.rs/viz/latest/viz/struct.Router.html#method.head><code>head</code></a></li><li><a href=https://docs.rs/viz/latest/viz/struct.Router.html#method.options><code>options</code></a></li><li><a href=https://docs.rs/viz/latest/viz/struct.Router.html#method.connect><code>connect</code></a></li><li><a href=https://docs.rs/viz/latest/viz/struct.Router.html#method.path><code>patch</code></a></li><li><a href=https://docs.rs/viz/latest/viz/struct.Router.html#method.trace><code>trace</code></a></li></ul><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>let</span> <span class=variable>routes</span> <span class=operator>=</span> <span class=type>Router</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>  <span class=punctuation.delimiter>.</span><span class=function>get</span><span class=punctuation.bracket>(</span><span class=string>"/about"</span><span class=punctuation.delimiter>,</span> <span class=punctuation.bracket>|</span>_: <span class=type>Request</span><span class=punctuation.bracket>|</span> <span class=keyword>async</span> <span class=punctuation.bracket>{</span> <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"About"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span> <span class=punctuation.bracket>}</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span></code></pre></div><h2 id=资源路由>资源路由<a class=anchor href=#资源路由>#</a></h2><p>使用约定的动作添加路由。支持以下动作：</p><table><thead><tr><th>HTTP 方法</th><th>路径</th><th>动作</th><th>用途</th></tr></thead><tbody><tr><td>GET</td><td><code>/resources</code></td><td><a href=https://docs.rs/viz/latest/viz/struct.Resources.html#method.index><code>index</code></a></td><td>显示资源列表</td></tr><tr><td>GET</td><td><code>/resources/new</code></td><td><a href=https://docs.rs/viz/latest/viz/struct.Resources.html#method.new><code>new</code></a></td><td>返回用于新建资源的 HTML 表单</td></tr><tr><td>POST</td><td><code>/resources</code></td><td><a href=https://docs.rs/viz/latest/viz/struct.Resources.html#method.create><code>create</code></a></td><td>新建资源</td></tr><tr><td>GET</td><td><code>/resources/:id</code></td><td><a href=https://docs.rs/viz/latest/viz/struct.Resources.html#method.show><code>show</code></a></td><td>显示指定资源</td></tr><tr><td>GET</td><td><code>/resources/:id/edit</code></td><td><a href=https://docs.rs/viz/latest/viz/struct.Resources.html#method.edit><code>edit</code></a></td><td>返回用于修改资源的 HTML 表单</td></tr><tr><td>PUT</td><td><code>/resources/:id</code></td><td><a href=https://docs.rs/viz/latest/viz/struct.Resources.html#method.update><code>update</code></a></td><td>更新指定资源</td></tr><tr><td>PATCH</td><td><code>/resources/:id</code></td><td><a href=https://docs.rs/viz/latest/viz/struct.Resources.html#method.update_with_patch><code>update_with_patch</code></a></td><td>更新指定资源</td></tr><tr><td>DELETE</td><td><code>/resources/:id</code></td><td><a href=https://docs.rs/viz/latest/viz/struct.Resources.html#method.destroy><code>destroy</code></a></td><td>删除指定资源</td></tr></tbody></table><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>let</span> <span class=variable>resources</span> <span class=operator>=</span> <span class=type>Resources</span><span class=punctuation.delimiter>::</span><span class=function>default</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>  <span class=punctuation.delimiter>.</span><span class=function>named</span><span class=punctuation.bracket>(</span><span class=string>"post"</span><span class=punctuation.bracket>)</span>
</span><span class=line>  <span class=punctuation.delimiter>.</span><span class=function>index</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>|</span>_: <span class=type>Request</span><span class=punctuation.bracket>|</span> <span class=keyword>async</span> <span class=punctuation.bracket>{</span> <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"posts index"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span> <span class=punctuation.bracket>}</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span></code></pre></div><h2 id=嵌套路由>嵌套路由<a class=anchor href=#嵌套路由>#</a></h2><p>可以把 <a href=https://docs.rs/viz/latest/viz/struct.Route.html><code>Route</code></a>、<a href=https://docs.rs/viz/latest/viz/struct.Resources.html><code>Resources</code></a>、<a href=https://docs.rs/viz/latest/viz/struct.Router.html><code>Router</code></a> 嵌入更大的路由当中。</p><p>以下是三种嵌套方法：</p><ul><li><p><a href=https://docs.rs/viz/latest/viz/struct.Router.html#method.route><code>route</code></a></p></li><li><p><a href=https://docs.rs/viz/latest/viz/struct.Router.html#method.resources><code>resources</code></a></p></li><li><p><a href=https://docs.rs/viz/latest/viz/struct.Router.html#method.nest><code>nest</code></a></p></li></ul><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>let</span> <span class=variable>search</span> <span class=operator>=</span> <span class=type>Route</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=function>get</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>|</span>_: <span class=type>Request</span><span class=punctuation.bracket>|</span> <span class=keyword>async</span> <span class=punctuation.bracket>{</span> <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"search"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span> <span class=punctuation.bracket>}</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=keyword>let</span> <span class=variable>orgs</span> <span class=operator>=</span> <span class=type>Resources</span><span class=punctuation.delimiter>::</span><span class=function>default</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>index</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>|</span>_: <span class=type>Request</span><span class=punctuation.bracket>|</span> <span class=keyword>async</span> <span class=punctuation.bracket>{</span> <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"list posts"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span> <span class=punctuation.bracket>}</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>create</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>|</span>_: <span class=type>Request</span><span class=punctuation.bracket>|</span> <span class=keyword>async</span> <span class=punctuation.bracket>{</span> <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"create post"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span> <span class=punctuation.bracket>}</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>show</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>|</span>_: <span class=type>Request</span><span class=punctuation.bracket>|</span> <span class=keyword>async</span> <span class=punctuation.bracket>{</span> <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"show post"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span> <span class=punctuation.bracket>}</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=keyword>let</span> <span class=variable>settings</span> <span class=operator>=</span> <span class=type>Router</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>get</span><span class=punctuation.bracket>(</span><span class=string>"/"</span><span class=punctuation.delimiter>,</span> <span class=punctuation.bracket>|</span>_: <span class=type>Request</span><span class=punctuation.bracket>|</span> <span class=keyword>async</span> <span class=punctuation.bracket>{</span> <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"settings"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span> <span class=punctuation.bracket>}</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>get</span><span class=punctuation.bracket>(</span><span class=string>"/:page"</span><span class=punctuation.delimiter>,</span> <span class=punctuation.bracket>|</span>_: <span class=type>Request</span><span class=punctuation.bracket>|</span> <span class=keyword>async</span> <span class=punctuation.bracket>{</span>
</span><span class=line>        <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"setting page"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.bracket>}</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=keyword>let</span> <span class=variable>api</span> <span class=operator>=</span> <span class=type>Router</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=function>route</span><span class=punctuation.bracket>(</span><span class=string>"/search"</span><span class=punctuation.delimiter>,</span> <span class=variable>search</span><span class=punctuation.delimiter>.</span><span class=function>clone</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=keyword>let</span> <span class=variable>app</span> <span class=operator>=</span> <span class=type>Router</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>get</span><span class=punctuation.bracket>(</span><span class=string>"/"</span><span class=punctuation.delimiter>,</span> <span class=punctuation.bracket>|</span>_: <span class=type>Request</span><span class=punctuation.bracket>|</span> <span class=keyword>async</span> <span class=punctuation.bracket>{</span> <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"index"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span> <span class=punctuation.bracket>}</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>route</span><span class=punctuation.bracket>(</span><span class=string>"search"</span><span class=punctuation.delimiter>,</span> <span class=variable>search</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>resources</span><span class=punctuation.bracket>(</span><span class=string>":org"</span><span class=punctuation.delimiter>,</span> <span class=variable>orgs</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>nest</span><span class=punctuation.bracket>(</span><span class=string>"settings"</span><span class=punctuation.delimiter>,</span> <span class=variable>settings</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>nest</span><span class=punctuation.bracket>(</span><span class=string>"api"</span><span class=punctuation.delimiter>,</span> <span class=variable>api</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span></code></pre></div><h2 id=中间件>中间件<a class=anchor href=#中间件>#</a></h2><p>即可以对单个 <code>handler</code> 添加中间件，也可以对所有路由添加中间件。</p><h3>handler</h3><p><a href=https://docs.rs/viz/latest/viz/handler/trait.HandlerExt.html><code>HandlerExt</code></a> 扩展特征提供了很多友好简便的方法，可以轻松地对 <code>handler</code> 进行包裹封装。</p><p>可以通过 <a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.around><code>around</code></a> 和 <a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.with><code>with</code></a> 对 <code>handler</code> 添加中间件。</p><ul><li><a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.around><code>around</code></a></li></ul><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>async</span> <span class=keyword.function>fn</span> <span class=function>middle_fn</span><span class=punctuation.bracket><</span><span class=type>H</span><span class=punctuation.bracket>></span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>(</span><span class=variable>req</span><span class=punctuation.delimiter>,</span> <span class=variable>h</span><span class=punctuation.bracket>)</span>: <span class=type>Next</span><span class=punctuation.bracket><</span><span class=type>Request</span><span class=punctuation.delimiter>,</span> <span class=type>H</span><span class=punctuation.bracket>></span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Result</span><span class=punctuation.bracket><</span><span class=type>Response</span><span class=punctuation.bracket>></span>
</span><span class=line><span class=keyword>where</span>
</span><span class=line>    <span class=type>H</span>: <span class=type>Handler</span><span class=punctuation.bracket><</span><span class=type>Request</span><span class=punctuation.delimiter>,</span> <span class=type>Output</span> <span class=operator>=</span> <span class=type>Result</span><span class=punctuation.bracket><</span><span class=type>Response</span><span class=punctuation.bracket>></span><span class=punctuation.bracket>></span> <span class=operator>+</span> <span class=type>Clone</span><span class=punctuation.delimiter>,</span>
</span><span class=line><span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=variable>h</span><span class=punctuation.delimiter>.</span><span class=function>call</span><span class=punctuation.bracket>(</span><span class=variable>req</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=keyword.return>await</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span><span class=line>
</span><span class=line><span class=keyword>let</span> <span class=variable>search</span> <span class=operator>=</span> <span class=punctuation.bracket>(</span><span class=punctuation.bracket>|</span>_: <span class=type>Request</span><span class=punctuation.bracket>|</span> <span class=keyword>async</span> <span class=punctuation.bracket>{</span> <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"search"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span> <span class=punctuation.bracket>}</span><span class=punctuation.bracket>)</span>
</span><span class=line>  <span class=punctuation.delimiter>.</span><span class=function>around</span><span class=punctuation.bracket>(</span><span class=variable>middle_fn</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span></code></pre></div><ul><li><a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.with><code>with</code></a></li></ul><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>struct</span> <span class=type>Timeout</span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=variable>delay</span>: <span class=type>Duration</span><span class=punctuation.delimiter>,</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span><span class=line>
</span><span class=line><span class=keyword>impl</span> <span class=type>Timeout</span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=keyword>pub</span> <span class=keyword.function>fn</span> <span class=function>new</span><span class=punctuation.bracket>(</span><span class=parameter>secs</span>: <span class=type.builtin>u64</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Self</span> <span class=punctuation.bracket>{</span>
</span><span class=line>        <span class=type>Self</span> <span class=punctuation.bracket>{</span> <span class=variable>delay</span>: <span class=type>Duration</span><span class=punctuation.delimiter>::</span><span class=function>from_secs</span><span class=punctuation.bracket>(</span><span class=parameter>secs</span><span class=punctuation.bracket>)</span> <span class=punctuation.bracket>}</span>
</span><span class=line>    <span class=punctuation.bracket>}</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span><span class=line>
</span><span class=line><span class=keyword>impl</span><span class=punctuation.bracket><</span><span class=type>H</span>: <span class=type>Clone</span><span class=punctuation.bracket>></span> <span class=type>Transform</span><span class=punctuation.bracket><</span><span class=type>H</span><span class=punctuation.bracket>></span> <span class=keyword>for</span> <span class=type>Timeout</span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=keyword>type</span> <span class=type>Output</span> <span class=operator>=</span> <span class=type>TimeoutMiddleware</span><span class=punctuation.bracket><</span><span class=type>H</span><span class=punctuation.bracket>></span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line>    <span class=keyword.function>fn</span> <span class=function>transform</span><span class=punctuation.bracket>(</span><span class=keyword>&</span><span class=variable.builtin>self</span><span class=punctuation.delimiter>,</span> <span class=parameter>h</span>: <span class=type>H</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Self</span><span class=punctuation.delimiter>::</span><span class=type>Output</span> <span class=punctuation.bracket>{</span>
</span><span class=line>        <span class=type>TimeoutMiddleware</span><span class=punctuation.bracket>(</span><span class=parameter>h</span><span class=punctuation.delimiter>,</span> <span class=variable.builtin>self</span><span class=punctuation.delimiter>.</span><span class=variable>delay</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.bracket>}</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span><span class=line>
</span><span class=line><span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>derive</span><span class=punctuation.bracket>(</span><span class=type>Clone</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>]</span>
</span><span class=line><span class=keyword>struct</span> <span class=type>TimeoutMiddleware</span><span class=punctuation.bracket><</span><span class=type>H</span><span class=punctuation.bracket>></span><span class=punctuation.bracket>(</span><span class=type>H</span><span class=punctuation.delimiter>,</span> <span class=type>Duration</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line><span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>async_trait</span><span class=punctuation.bracket>]</span>
</span><span class=line><span class=keyword>impl</span><span class=punctuation.bracket><</span><span class=type>H</span><span class=punctuation.bracket>></span> <span class=type>Handler</span><span class=punctuation.bracket><</span><span class=type>Request</span><span class=punctuation.bracket>></span> <span class=keyword>for</span> <span class=type>TimeoutMiddleware</span><span class=punctuation.bracket><</span><span class=type>H</span><span class=punctuation.bracket>></span>
</span><span class=line><span class=keyword>where</span>
</span><span class=line>    <span class=type>H</span>: <span class=type>Handler</span><span class=punctuation.bracket><</span><span class=type>Request</span><span class=punctuation.bracket>></span> <span class=operator>+</span> <span class=type>Clone</span><span class=punctuation.delimiter>,</span>
</span><span class=line><span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=keyword>type</span> <span class=type>Output</span> <span class=operator>=</span> <span class=constant>H</span><span class=punctuation.delimiter>::</span><span class=type>Output</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line>    <span class=keyword>async</span> <span class=keyword.function>fn</span> <span class=function>call</span><span class=punctuation.bracket>(</span><span class=keyword>&</span><span class=variable.builtin>self</span><span class=punctuation.delimiter>,</span> <span class=parameter>req</span>: <span class=type>Request</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Self</span><span class=punctuation.delimiter>::</span><span class=type>Output</span> <span class=punctuation.bracket>{</span>
</span><span class=line>        <span class=variable.builtin>self</span><span class=punctuation.delimiter>.</span><span class=constant>0</span><span class=punctuation.delimiter>.</span><span class=function>call</span><span class=punctuation.bracket>(</span><span class=parameter>req</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=keyword.return>await</span>
</span><span class=line>    <span class=punctuation.bracket>}</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span><span class=line>
</span><span class=line><span class=keyword>let</span> <span class=variable>search</span> <span class=operator>=</span> <span class=punctuation.bracket>(</span><span class=punctuation.bracket>|</span>_: <span class=type>Request</span><span class=punctuation.bracket>|</span> <span class=keyword>async</span> <span class=punctuation.bracket>{</span> <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"search"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span> <span class=punctuation.bracket>}</span><span class=punctuation.bracket>)</span>
</span><span class=line>  <span class=punctuation.delimiter>.</span><span class=function>with</span><span class=punctuation.bracket>(</span><span class=namespace>timeHMS</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span></code></pre></div><h3>所有路由</h3><p><a href=https://docs.rs/viz/latest/viz/struct.Route.html><code>Route</code></a>、<a href=https://docs.rs/viz/latest/viz/struct.Resources.html><code>Resources</code></a>、<a href=https://docs.rs/viz/latest/viz/struct.Router.html><code>Router</code></a> 都提供了两个方法来添加中间件 <code>with</code> 和 <code>with_handler</code>。</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>let</span> <span class=variable>routes</span> <span class=operator>=</span> <span class=type>Router</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>  <span class=punctuation.delimiter>.</span><span class=function>get</span><span class=punctuation.bracket>(</span><span class=string>"/"</span><span class=punctuation.delimiter>,</span> <span class=punctuation.bracket>|</span>_: <span class=type>Request</span><span class=punctuation.bracket>|</span> <span class=keyword>async</span> <span class=punctuation.bracket>{</span> <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"index"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span> <span class=punctuation.bracket>}</span>
</span><span class=line>    <span class=comment>// handler middleware</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>with</span><span class=punctuation.bracket>(</span><span class=type>Timeout</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>with_handler</span><span class=punctuation.bracket>(</span><span class=variable>middle_fn</span><span class=punctuation.bracket>)</span>
</span><span class=line>  <span class=punctuation.bracket>)</span>
</span><span class=line>  <span class=punctuation.delimiter>.</span><span class=function>route</span><span class=punctuation.bracket>(</span><span class=string>"/search"</span><span class=punctuation.delimiter>,</span> <span class=type>Route</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>get</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>|</span>_: <span class=type>Request</span><span class=punctuation.bracket>|</span> <span class=keyword>async</span> <span class=punctuation.bracket>{</span> <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"search"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span> <span class=punctuation.bracket>}</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=comment>// route middle_fn</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>with</span><span class=punctuation.bracket>(</span><span class=type>Timeout</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>with_handler</span><span class=punctuation.bracket>(</span><span class=variable>middle_fn</span><span class=punctuation.bracket>)</span>
</span><span class=line>  <span class=punctuation.bracket>)</span>
</span><span class=line>  <span class=punctuation.delimiter>.</span><span class=function>resources</span><span class=punctuation.bracket>(</span><span class=string>"/posts"</span><span class=punctuation.delimiter>,</span> <span class=type>Resources</span><span class=punctuation.delimiter>::</span><span class=function>default</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>named</span><span class=punctuation.bracket>(</span><span class=string>"post"</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>index</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>|</span>_: <span class=type>Request</span><span class=punctuation.bracket>|</span> <span class=keyword>async</span> <span class=punctuation.bracket>{</span> <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"posts index"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span> <span class=punctuation.bracket>}</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=comment>// resources middleware</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>with</span><span class=punctuation.bracket>(</span><span class=type>Timeout</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>with_handler</span><span class=punctuation.bracket>(</span><span class=variable>middle_fn</span><span class=punctuation.bracket>)</span>
</span><span class=line>  <span class=punctuation.bracket>)</span>
</span><span class=line>  <span class=punctuation.delimiter>.</span><span class=function>nest</span><span class=punctuation.bracket>(</span><span class=string>"/users"</span><span class=punctuation.delimiter>,</span> <span class=type>Router</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=comment>// router middleware</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>with</span><span class=punctuation.bracket>(</span><span class=type>Timeout</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.delimiter>.</span><span class=function>with_handler</span><span class=punctuation.bracket>(</span><span class=variable>middle_fn</span><span class=punctuation.bracket>)</span>
</span><span class=line>  <span class=punctuation.bracket>)</span>
</span><span class=line>  <span class=comment>// router middleware</span>
</span><span class=line>  <span class=punctuation.delimiter>.</span><span class=function>with</span><span class=punctuation.bracket>(</span><span class=type>Timeout</span><span class=punctuation.delimiter>::</span><span class=function>new</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span>
</span><span class=line>  <span class=punctuation.delimiter>.</span><span class=function>with_handler</span><span class=punctuation.bracket>(</span><span class=variable>middle_fn</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span></code></pre></div><h2 id=例子>例子<a class=anchor href=#例子>#</a></h2><ul><li><a href=https://github.com/viz-rs/viz/tree/0.4.x/examples/routing/todos>Todos</a></li></ul></article><nav class="flex-col gap-5 hidden lg:flex"><div class="py-1 text-2 uppercase">本页目录</div><ul class=text-3><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#概念及结构>概念及结构</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#路径参数>路径参数</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#方法路由>方法路由</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#资源路由>资源路由</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#嵌套路由>嵌套路由</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#中间件>中间件</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#例子>例子</a></li></ul></nav>