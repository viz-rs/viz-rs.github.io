<article class=flex-1><h1 id=请求处理>请求处理<a class=anchor href=#请求处理>#</a></h1><h2 id=基础特征>基础特征<a class=anchor href=#基础特征>#</a></h2><p>在 Viz 中，定义了一个基础特征 <a href=https://docs.rs/viz/latest/viz/trait.Handler.html><code>Handler</code></a> 来处理请求，它的接口非常简单，只有一个输入和一个输出， 内部已对异步函数实现了该特征，所以可以轻松地构建异步处理。</p><p>下面是 <a href=https://docs.rs/viz/latest/viz/trait.Handler.html><code>Handler</code></a> 的定义：</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>async_trait</span><span class=punctuation.bracket>]</span>
</span><span class=line><span class=keyword>pub</span> <span class=keyword>trait</span> <span class=type>Handler</span><span class=punctuation.bracket><</span><span class=type>Input</span><span class=punctuation.bracket>></span>: <span class=namespace>dyn_clone</span><span class=punctuation.delimiter>::</span><span class=type>DynClone</span> <span class=operator>+</span> <span class=type>Send</span> <span class=operator>+</span> <span class=type>Sync</span> <span class=operator>+</span> <span class=label>'</span><span class=label>static</span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=keyword>type</span> <span class=type>Output</span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line>    <span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>must_use</span><span class=punctuation.bracket>]</span>
</span><span class=line>    <span class=keyword>async</span> <span class=keyword.function>fn</span> <span class=function>call</span><span class=punctuation.bracket>(</span><span class=keyword>&</span><span class=variable.builtin>self</span><span class=punctuation.delimiter>,</span> <span class=parameter>input</span>: <span class=type>Input</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Self</span><span class=punctuation.delimiter>::</span><span class=type>Output</span><span class=punctuation.delimiter>;</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span></code></pre></div><h3>一个简单的异步处理函数</h3><p>其中输入 <a href=https://docs.rs/viz/latest/viz/type.Request.html><code>Request</code></a>，输出 Result<<a href=https://docs.rs/viz/latest/viz/type.Response.html><code>Response</code></a>>。</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=keyword>async</span> <span class=keyword.function>fn</span> <span class=function>index</span><span class=punctuation.bracket>(</span>_: <span class=type>Request</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Result</span><span class=punctuation.bracket><</span><span class=type>Response</span><span class=punctuation.bracket>></span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=type>Response</span><span class=punctuation.delimiter>::</span><span class=function>text</span><span class=punctuation.bracket>(</span><span class=string>"Hello, World!"</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span></code></pre></div><h3>支持自定义类型</h3><p>通过自定义类型，实现 <a href=https://docs.rs/viz/latest/viz/trait.Handler.html><code>Handler</code></a> 特征来构造请求处理。</p><div class=code><button class="i-lucide-copy transition w-4 h-4 select-none absolute top-4 right-2 op-20 hover:op-80"></button><pre class=language-rust><code><span class=line><span class=punctuation.bracket>#</span><span class=punctuation.bracket>[</span><span class=function.macro>derive</span><span class=punctuation.bracket>(</span><span class=type>Clone</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>]</span>
</span><span class=line><span class=keyword>struct</span> <span class=type>MyHandler</span> <span class=punctuation.bracket>{</span>
</span><span class=line>  <span class=variable>count</span>: <span class=type>Arc</span><span class=punctuation.bracket><</span><span class=type>AtomicUsize</span><span class=punctuation.bracket>></span><span class=punctuation.delimiter>,</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span><span class=line>
</span><span class=line><span class=keyword>impl</span> <span class=type>Handler</span><span class=punctuation.bracket><</span><span class=type>Request</span><span class=punctuation.bracket>></span> <span class=keyword>for</span> <span class=type>MyHandler</span> <span class=punctuation.bracket>{</span>
</span><span class=line>    <span class=keyword>type</span> <span class=type>Output</span> <span class=operator>=</span> <span class=type>Result</span><span class=punctuation.bracket><</span><span class=type>Response</span><span class=punctuation.bracket>></span><span class=punctuation.delimiter>;</span>
</span><span class=line>
</span><span class=line>    <span class=keyword>async</span> <span class=keyword.function>fn</span> <span class=function>call</span><span class=punctuation.bracket>(</span><span class=keyword>&</span><span class=variable.builtin>self</span><span class=punctuation.delimiter>,</span> <span class=parameter>req</span>: <span class=type>Request</span><span class=punctuation.bracket>)</span> <span class=operator>-></span> <span class=type>Self</span><span class=punctuation.delimiter>::</span><span class=type>Output</span> <span class=punctuation.bracket>{</span>
</span><span class=line>        <span class=keyword>let</span> <span class=variable>path</span> <span class=operator>=</span> <span class=parameter>req</span><span class=punctuation.delimiter>.</span><span class=function>path</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=function>clone</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span><span class=line>        <span class=keyword>let</span> <span class=variable>method</span> <span class=operator>=</span> <span class=parameter>req</span><span class=punctuation.delimiter>.</span><span class=function>method</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=function>clone</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span><span class=line>        <span class=keyword>let</span> <span class=variable>count</span> <span class=operator>=</span> <span class=variable.builtin>self</span><span class=punctuation.delimiter>.</span><span class=variable>count</span><span class=punctuation.delimiter>.</span><span class=function>fetch_add</span><span class=punctuation.bracket>(</span><span class=constant>1</span><span class=punctuation.delimiter>,</span> <span class=type>Ordering</span><span class=punctuation.delimiter>::</span><span class=type>SeqCst</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>;</span>
</span><span class=line>        <span class=type>Ok</span><span class=punctuation.bracket>(</span><span class=function.macro>format</span><span class=function.macro>!</span><span class=punctuation.bracket>(</span><span class=string>"method = {}, path = {}, count = {}"</span>, <span class=variable>method</span>, <span class=variable>path</span>, <span class=variable>count</span><span class=punctuation.bracket>)</span><span class=punctuation.delimiter>.</span><span class=function>into_response</span><span class=punctuation.bracket>(</span><span class=punctuation.bracket>)</span><span class=punctuation.bracket>)</span>
</span><span class=line>    <span class=punctuation.bracket>}</span>
</span><span class=line><span class=punctuation.bracket>}</span>
</span></code></pre></div><h2 id=扩展特征>扩展特征<a class=anchor href=#扩展特征>#</a></h2><p><a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html><code>HandlerExt</code></a> 是对 <a href=https://docs.rs/viz/latest/viz/trait.Handler.html><code>Handler</code></a> 的扩展，提供了各种方便的适配器，通过链式和组合的方式去构造请求处理。</p><p>以下是扩展方法列表：</p><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.boxed><code>boxed</code></a></td><td>包裹 <code>handler</code>，将它存储在堆上</td></tr><tr><td><a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.before><code>before</code></a></td><td>在执行 <code>handler</code> 前，对输入进行处理</td></tr><tr><td><a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.after><code>after</code></a></td><td>在执行 <code>handler</code> 后，对输出进行处理</td></tr><tr><td><a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.around><code>around</code></a></td><td>在执行 <code>handler</code> 时，自定义前置、后置处理</td></tr><tr><td><a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.map><code>map</code></a></td><td>在执行 <code>handler</code> 后，对正确结果进行处理</td></tr><tr><td><a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.map_into_response><code>map_into_response</code></a></td><td>在执行 <code>handler</code> 后，把正确结果转换成 <a href=https://docs.rs/viz/latest/viz/type.Response.html><code>Response</code></a></td></tr><tr><td><a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.and_then><code>and_then</code></a></td><td>在执行 <code>handler</code> 后，添加一个操作来处理正确结果</td></tr><tr><td><a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.map_err><code>map_err</code></a></td><td>在执行 <code>handler</code> 后，对错误结果进行处理</td></tr><tr><td><a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.or_err><code>or_err</code></a></td><td>在执行 <code>handler</code> 后，添加一个操作来处理错误结果</td></tr><tr><td><a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.catch_error><code>catch_error</code></a></td><td>在执行 <code>handler</code> 时，捕获错误信息并处理</td></tr><tr><td><a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.catch_unwind><code>catch_unwind</code></a></td><td>在执行 <code>handler</code> 时，捕获错误信息并阻止 <code>panic</code></td></tr><tr><td><a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.with><code>with</code></a></td><td>用一个实现 <a href=https://docs.rs/viz/latest/viz/trait.Transform.html><code>Transform</code></a> 特征的类型包裹 <code>handler</code></td></tr><tr><td><a href=https://docs.rs/viz/latest/viz/trait.HandlerExt.html#method.with_fn><code>with_fn</code></a></td><td>添加一个操作，对 <code>handler</code> 进行处理或者转换</td></tr></tbody></table><blockquote><p>这里先简单介绍下，在路由章节会详细展开</p></blockquote></article><nav class="flex-col gap-5 hidden lg:flex"><div class="py-1 text-2 uppercase">本页目录</div><ul class=text-3><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#基础特征>基础特征</a></li><li><a class="block py-1 font-normal transition-colors op75 hover:op100"href=#扩展特征>扩展特征</a></li></ul></nav>